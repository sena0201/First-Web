var t=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))((function(n,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function s(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,s)}c((i=i.apply(t,e||[])).next())}))},e=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Comics=void 0;const r=require("cheerio"),i=e(require("axios"));const n=new class{constructor(){this.domain="https://www.nettruyen.com"}createRequest(e){return t(this,void 0,void 0,(function*(){try{const{data:t}=yield i.default.request({method:"GET",url:`${this.domain}/${e}`.replace(/\?+/g,"?"),headers:{"User-Agent":"*"}});return(0,r.load)(t)}catch(t){throw t}}))}getComicId(t){var e;return t?null===(e=null==t?void 0:t.match(/\/([^/]+)-\d+$/))||void 0===e?void 0:e[1]:""}getGenreId(t){var e;return t?null===(e=null==t?void 0:t.match(/[^/]+$/))||void 0===e?void 0:e[0]:""}formatTotal(t){return t?"N/A"===t?"Updating":Number(null==t?void 0:t.replace(/\./g,"")):0}trim(t){return null==t?void 0:t.replace(/\n/g,"").trim()}getComics(e,r=1,i="all"){var n,a;return t(this,void 0,void 0,(function*(){const t={"Thể loại":"genres","Tình trạng":"status","Lượt xem":"total_views","Bình luận":"total_comments","Theo dõi":"followers","Tên khác":"other_names","Ngày cập nhật":"updated_at","Tác giả":"authors"},o={all:-1,updating:1,completed:2};if(!o[i])throw Error("Invalid status");try{const[s,c]=yield Promise.all([this.createRequest(e.includes("tim-truyen")?`${e}&status=${o[i]}&page=${r}`:`${e+(e.includes("?")?"&":"?")}page=${r}`),this.getGenres()]),h=(null===(a=null===(n=s('a[title="Trang cuối"]'))||void 0===n?void 0:n.attr("href"))||void 0===a?void 0:a.split("=").at(-1))||s(".pagination-outter li.active a").text()||1;if(r>Number(h))return{status:404,message:"Page not found"};const d=Array.from(s("#ctl00_divCenter .item")).map((e=>{const r="https:"+s(".image img",e).attr("data-original"),i=this.trim(s("figcaption h3",e).text()),n=this.getComicId(s("a",e).attr("href")),a=!!s(".icon-hot",e).toString(),o=s(".box_text",e).text().replace(/-/g,"").replace(/\n/g," "),h=Array.from(s(".message_main p",e)).map((e=>{var r;const[i,n,a]=null===(r=this.trim(s(e).text()))||void 0===r?void 0:r.match(/^(.*?):(.*)$/),o=/, |;\s*| - /.test(a)?a.split(/, |;\s*| - /):a,h=t[n];if("genres"===h){return{genres:(Array.isArray(o)?o:[o]).map((t=>{const e=c.find((e=>e.name===t));return{id:null==e?void 0:e.id,name:null==e?void 0:e.name}}))}}return"status"===h?{status:"Hoàn thành"===o?"Completed":"Updating"}:{[h]:o}})),d=Array.from(s(".comic-item li",e)).map((t=>({id:Number(s("a",t).attr("data-id")),name:s("a",t).text(),updated_at:s(".time",t).text()})));return Object.assign({},{thumbnail:r,title:i,id:n,is_trending:a,short_description:o,lastest_chapters:d,genres:[],other_names:[],status:"Updating",total_views:"Updating",total_comments:"Updating",followers:"Updating",updated_at:"Updating",authors:"Updating"},...h)}));return{comics:d,total_pages:Number(h),current_page:r}}catch(t){throw t}}))}getChapters(e){var r;return t(this,void 0,void 0,(function*(){try{const[t,n]=e.split(/^([\w-]+)(?:-\d+)?$/),a=(yield this.createRequest(`truyen-tranh/${n}`))(".star").attr("data-id"),{data:o}=yield i.default.get(`${this.domain}/Comic/Services/ComicService.asmx/ProcessChapterList?comicId=${a}`,{headers:{"User-Agent":"*"}});return null===(r=o.chapters)||void 0===r?void 0:r.map((t=>({id:t.chapterId,name:t.name})))}catch(t){throw t}}))}getGenres(){return t(this,void 0,void 0,(function*(){try{const t=yield this.createRequest("");return[...Array.from(t("#mainNav .clearfix li a")).map((e=>{const r=this.getGenreId(t(e).attr("href"));return{id:"tim-truyen"===r?"all":r,name:this.trim(t(e).text()),description:t(e).attr("data-title")}})),{id:"16",name:"16+",description:"Là thể loại có nhiều cảnh nóng, đề cập đến các vấn đề nhạy cảm giới tính hay các cảnh bạo lực máu me .... Nói chung là truyện có tác động xấu đến tâm sinh lý của những độc giả chưa đủ 16 tuổi"}]}catch(t){throw t}}))}getRecommendComics(e="hot"){return t(this,void 0,void 0,(function*(){const t=yield this.createRequest({hot:"hot",boy:"truyen-con-trai",girl:"truyen-con-gai"}[e]);return Array.from(t("#ctl00_divAlt1 div.item")).map((e=>({id:this.getComicId(t("a",e).attr("href")),title:t("a",e).attr("title"),thumbnail:"https:"+t("img",e).attr("data-src"),updated_at:this.trim(t(".time",e).text()),lastest_chapter:{id:Number(t(".slide-caption > a",e).attr("href").split("/").at(-1)),name:t(".slide-caption > a",e).text()}})))}))}getRecentUpdateComics(e=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("",e)}catch(t){throw t}}))}getCompletedComics(e=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("truyen-full",e)}catch(t){throw t}}))}getNewComics(e="all",r=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("tim-truyen?sort=15",r,e)}catch(t){throw t}}))}getComicsByGenre(e,r=1,i="all"){return t(this,void 0,void 0,(function*(){try{const t="all"===e?"tim-truyen?":`tim-truyen/${e}?`;return yield this.getComics(t,r,i)}catch(t){throw t}}))}getTopDailyComics(e="all",r=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("tim-truyen?sort=13",r,e)}catch(t){throw t}}))}getTopWeeklyComics(e="all",r=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("tim-truyen?sort=12",r,e)}catch(t){throw t}}))}getTopMonthlyComics(e="all",r=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("tim-truyen?sort=11",r,e)}catch(t){throw t}}))}getTopFollowComics(e="all",r=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("tim-truyen?sort=20",r,e)}catch(t){throw t}}))}getTopCommentComics(e="all",r=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("tim-truyen?sort=25",r,e)}catch(t){throw t}}))}getTopAllComics(e="all",r=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("tim-truyen?sort=10",r,e)}catch(t){throw t}}))}getTopChapterComics(e="all",r=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("tim-truyen?sort=30",r,e)}catch(t){throw t}}))}getTrendingComics(e=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("hot?",e)}catch(t){throw t}}))}getBoyComics(e=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("truyen-con-trai?",e)}catch(t){throw t}}))}getGirlComics(e=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics("truyen-con-gai?",e)}catch(t){throw t}}))}searchComics(e,r=1){return t(this,void 0,void 0,(function*(){try{return yield this.getComics(`tim-truyen?keyword=${e.replace(/\s+/g,"+")}&`,r)}catch(t){throw t}}))}getComicDetail(e){return t(this,void 0,void 0,(function*(){try{const[t,r]=yield Promise.all([this.createRequest(`truyen-tranh/${e}`),this.getChapters(e)]),i=t(".title-detail").text(),n="https:"+t("#item-detail .col-image img").attr("src"),a=t(".detail-content p").text().replace(/\n/g," ").replace(/-/g,"").trim();let o=t(".author p:nth-child(2)").text();o=/, |;\s*| - /.test(o)?o.split(/, |;\s*| - /):"Đang cập nhật"!==o?t(".author p:nth-child(2)").text():"Updating";const s="Hoàn thành"===t(".status p:nth-child(2)").text()?"Finished":"Updating",c=Array.from(t(".kind p:nth-child(2) a")).map((e=>({id:this.getGenreId(t(e).attr("href")),name:t(e).text()}))),h=!!t(".alert-danger").toString(),d=t(".other-name").text().split(/, |;| - /).map((t=>t.trim())),m=this.formatTotal(t(".list-info .row:last-child p:nth-child(2)").text()),u=Number(t('span[itemprop="ratingCount"]').text()),l=Number(t('span[itemprop="ratingValue"]').text());return{title:i,thumbnail:n,description:a,authors:o,status:s,genres:c,total_views:m,average:l,rating_count:u,followers:this.formatTotal(t(".follow b").text()),chapters:r,id:e,is_adult:h,other_names:""!==d[0]?d:[]}}catch(t){throw t}}))}getChapter(e,r){return t(this,void 0,void 0,(function*(){try{const t=e.replace(/-\d+$/,""),[i,n]=yield Promise.all([this.createRequest(`truyen-tranh/${t}/chapter/${r}`),this.getChapters(e)]),a=Array.from(i(".page-chapter img")).map((t=>({page:Number(i(t).attr("data-index")),src:`https://api-comics-9g0r.onrender.com?src=https:${i(t).attr("src")}`}))),o=i(".breadcrumb li:last-child").first().text();return{images:a,chapters:n,chapter_name:o,comic_name:i(".breadcrumb li:nth-last-child(2)").first().text()}}catch(t){throw t}}))}getComicsByAuthor(e){return t(this,void 0,void 0,(function*(){try{return this.getComics(`/tim-truyen?tac-gia=${e.replace(/\s+/,"+")}`)}catch(t){throw t}}))}getComments(e,n=1,a=-1){return t(this,void 0,void 0,(function*(){try{const t=yield this.createRequest(`truyen-tranh/${e}`),o=t('head meta[property="og:image"]').attr("content").match(/\/(\d+)\./)[1],s=t("#ctl00_divCenter > script").text().match(/'([^']+)'/)[1],c=t=>`${this.domain}/Comic/Services/CommentService.asmx/List?comicId=${o}&orderBy=0&chapterId=${t}&parentId=0&pageNumber=${n}&token=${s}`;let h;const[d,m]=yield Promise.all([i.default.get(c(a),{headers:{"User-Agent":"*"}}),i.default.get(c(-1),{headers:{"User-Agent":"*"}})]);if(d.data.success)h=d.data;else{if(!m.data.success)return{status:400,message:"Something went wrong!"};h=m.data}const u=Number(h.commentCount.replace(",","")),l=(0,r.load)(h.response),g=Math.ceil(u/15);if(n>g)return{status:400,message:"Invalid page"};return{comments:Array.from(l(".clearfix")).map((t=>{const e="https:"+l(".avatar img",t).attr("src"),r=l(t).find(".authorname").first().text().trim(),i=l(".comment-content",t).first().text().trim(),n=l(".comment-footer .vote-up-count",t).first().text(),a=Array.from(l(t).find("> .summary > .info > .comment-content > img")).map((t=>{var e,r;return null===(r=null===(e=l(t).attr("src"))||void 0===e?void 0:e.match(/url=(.*)$/))||void 0===r?void 0:r[1]})),o=l(".comment-footer abbr",t).first().attr("title"),s=Array.from(l(".item",t)).map((t=>{const e="https:"+l(".avatar img",t).attr("src"),r=l(".authorname",t).text().trim(),i=l(".comment-content",t).clone().children().remove().end().text().trim(),n=l(".comment-footer .vote-up-count",t).text(),a=Array.from(l(".comment-content > img",t)).map((t=>{var e,r;return null===(r=null===(e=l(t).attr("src"))||void 0===e?void 0:e.match(/url=(.*)$/))||void 0===r?void 0:r[1]})),o=l(".comment-footer abbr",t).attr("title"),s=l(".mention-user",t).text().trim();return{avatar:e,username:r,content:i,stickers:a,created_at:o,vote_count:parseInt(n),mention_user:s}}));return{avatar:e,username:r,content:i,stickers:a,replies:s,created_at:o,vote_count:parseInt(n)}})),total_comments:u,total_pages:g,current_page:n}}catch(t){throw t}}))}getSearchSuggest(e){return t(this,void 0,void 0,(function*(){try{if(!(e=e.trim()))throw Error("Invalid query");const{data:t}=yield i.default.get(`${this.domain}/Comic/Services/SuggestSearch.ashx?q=${e}`,{headers:{"User-Agent":"*"}}),n=(0,r.load)(t);return Array.from(n("li")).map((t=>{const e=this.getComicId(n("a",t).attr("href")),r="https:"+n("img",t).attr("src"),i=n("h3",t).text(),a=n("i",t).first().text(),o=n("i",t).last().text(),s=n("b",t).text()||"Updating";return{id:e,title:i,thumbnail:r,lastest_chapter:a.startsWith("Chapter")?a:"Updating",genres:o!==a?o.split(", "):"Updating",authors:"Updating"===s?s:s.split(" - ")}}))}catch(t){throw t}}))}};exports.Comics=n;